<!DOCTYPE html>
<html lang="fi">
    <head>
        <% include head %>

        <script>
            document.addEventListener('DOMContentLoaded', (event) => {
                const omat = document.querySelectorAll('.oma');
                omat.forEach(item => {
                    item.addEventListener('dragstart', dragStart, false);
                    item.addEventListener('dragend', dragEnd, false);
                });

                function dragStart(e){
                    this.style.opacity='0.4';
                    e.dataTransfer.setData('text/plain', e.target.id);                    

                    targetit.forEach(item =>{
                        item.style.zIndex='50';
                        item.classList.add('hilit_dz');
                        e.target.style.opacity='.4';
                        
                    });
                }

                function dragEnd(e){
                    this.style.opacity='1';
                    targetit.forEach(item =>{
                        item.classList.remove('hilit_dz');
                        item.style.zIndex='-5';
                        e.target.style.opacity='1';
                    });
                }

                const targetit = document.querySelectorAll('.dropzone');
                targetit.forEach(item => {
                    item.addEventListener('dragenter', dragEnter);
                    item.addEventListener('dragover', dragOver);
                    item.addEventListener('dragleave', dragLeave);
                    item.addEventListener('drop', drop);
                });

                function dragEnter(e){

                    e.preventDefault();
                    e.target.classList.add('hilit_dz');
                    e.target.style.opacity='0.8';

                }
                function dragOver(e){
                    e.preventDefault();

                }
                function dragLeave(e){
                    //e.target.classList.remove('hilit_dz');
                    e.target.style.opacity='.4';
                }
                function drop(e){

                    const noutoId = e.dataTransfer.getData('text/plain');
                    const iidee = document.getElementById(noutoId).getElementsByTagName('span')[0].innerHTML;
                    //const topikki = document.getElementById(noutoId).getElementsByTagName('span')[1].innerHTML;

                    if(this.id =='jatkoon'){
                        window.location.href='/uusi_viesti/?muokkaa='+iidee;
                    } else { //ts. poistoon
                        let muuId = etsiMuuId(iidee);
                        if (muuId == undefined) {
                            window.location.href = '?./delid='+iidee;               
                        } else {
                            window.location.href = './?id='+muuId+'&delid='+iidee;                
                        }
                    }
                }
            });


            function etsiMuuId(verrokki) {
                const idt = document.querySelectorAll('.tunnus');
                let ret;// = undefined;
                for (i of idt){
                    if (i.innerHTML != verrokki) {
                        ret = i.innerHTML;
                        break;
                    }
                }
                return ret;
            }

        </script>
    </head>
    <body class="container-fluid">
        <% include header %>
        <% include hallinta %>
        <div class="dropzone" id="poistoon" ></div>
        <main class="flex justify-content-center flex-column">
            <div class="serif"><a href="/">Aiheet</a> > Keskustelu aiheesta:
            </div>

            <section><h2 class="serif"><%= messages[0].topic %></h2></section>
            <section>
                <% for(var i = 0; i < messages.length; i++) { %>
                <article class="kommentti row <%-  (messages[i].sender == login)?'oma':'' %> " <%-  (messages[i].sender == login)?'id="oma_'+messages[i].id+'" draggable="true" ':''   %> >
                    <span class="tunnus col-sm-1"><%= messages[i].id %></span>
                    <span style="display:none;"><%= messages[i].topic %></span>
                    <div class="col-sm-9 row">
                        <h3 class="otsikko col-sm-12"><b class="serif"><%- (messages[i].sender== login)?'Sinä</b> sanot':messages[i].sender+'</b> sanoo'   %>:</h3>
                        <p class="col-sm-12 <%= (h_tiivis)?'tiivis':''%>" id="komm_<%-messages[i].id %>"><%= messages[i].message%></p>
                    </div>
                    <%- (h_tiivis)?'<button id="nappi_'+messages[i].id+'" class="col-sm-2 btn btn-dark" onclick="laajennaYksi('+messages[i].id+')" value="Laajenna">Laajenna</button>':'' %>

                </article>
                <%- (i< messages.length-1)?'<hr>':''; %>
                <% }%>
            </section>

            <script>
                function laajennaYksi(id){

                    var para = "komm_"+id;
                    var nappi = "nappi_"+id;

                    if (document.getElementById(para).classList.contains("tiivis")) {
                        document.getElementById(para).classList.remove("tiivis");
                        document.getElementById(nappi).innerHTML ="Tiivistä";
                    } else {
                        document.getElementById(para).classList.add("tiivis");
                        document.getElementById(nappi).innerHTML ="Laajenna";
                    }

                }
            </script>
        </main>
        <% include footer %>
        <div class="dropzone" id="jatkoon"></div> <!-- ondrop="drop(event)" ondragover="allowDrop(event)" -->
    </body>
</html>
